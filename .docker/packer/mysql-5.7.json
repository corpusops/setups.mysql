{
    "variables": {
        "_p": "/provision_dir",
        "ansible_playbook": "/srv/corpusops/corpusops.bootstrap/bin/ansible-playbook",
        "ansible_args": "-vvvvv -c local -i localhost, -e@.ansible/vaults/default.yml -e@.ansible/vaults/app.yml -e@.ansible/vaults/docker.yml",
        "DO_UP": "",
        "DO_CONTAINER_STRIP": "1",
        "docker_folder": ".docker",
        "salt_folder": ".salt",
        "ansible_folder": ".ansible",
        "ansible_play": "playbooks/site_docker.yml",
        "tag": "corpusops/mysql:5.7",
        "img_entrypoint": "/entry_point",
        "entrypoint": "/app_entry_point",
        "author": "corpusops",
        "tag_image": "corpusops/mysql",
        "tag_name": "mysql",
        "tag_version": "5.7",
        "provisiondir_rsync_opts": "-azv --delete",
        "docker_name": "packer-{{uuid}}",
        "volumes": "[\"/setup\", \"/srv/projects/mysql/data\"]",
        "img_debug": "1"
    },
    "builders":[
        {
        "type": "docker",
        "image": "corpusops/ubuntu:16.04",
        "author": "{{user `author`}}",
        "run_command": [
            "-v", "/sys/fs/cgroup:/sys/fs/cgroup:ro",
            "-v", "{{pwd}}:{{user  `_p`}}.in:ro",
            "--security-opt", "seccomp=unconfined",
            "-e", "COPS_IMGTAG={{user `tag`}}",
            "-e", "COPS_IMG={{user `tag_image`}}",
            "-e", "COPS_IMGNAME={{user `tag_name`}}",
            "-e", "COPS_IMGVER={{user `tag_version`}}",
            "-e", "ANSIBLE_PLAYBOOK={{user `ansible_playbook`}}",
            "-e", "ANSIBLE_PLAY={{user `ansible_play`}}",
            "-e", "ANSIBLE_FOLDER={{user `ansible_folder`}}",
            "-d", "-i", "-t",
            "--name", "{{user `docker_name`}}",
            "{{.Image}}", "{{user `img_entrypoint`}}"
        ],
        "commit": "true",
        "changes": [
            "VOLUME /data",
            "VOLUME /var/lib/mysql",
            "ENV USE_INIT=1",
            "EXPOSE 3306",
            "CMD bash",
            "VOLUME {{user `volumes`}}",
            "LABEL maintainer \"{{user `author`}}\"",
            "ENTRYPOINT {{user `entrypoint`}}"
        ]
    }],
    "provisioners": [
        {
            "type": "shell",
            "inline_shebang": "/bin/bash -ex",
            "inline":  [
                "echo \"---\"> /tmp/ansible_params.yml",
                "echo \"cops_es_version: {{user `tag_version`}}\" > /tmp/ansible_params.yml"
            ]
        },
        {
        "type": "shell",
        "environment_vars": [
            "_P={{user `_p`}}",
            "ANSIBLE_PLAYBOOK={{user `ansible_playbook`}}",
            "ANSIBLE_PLAY={{user `ansible_play`}}",
            "ANSIBLE_FOLDER={{user `ansible_folder`}}",
            "ANSIBLE_ARGS={{user `ansible_args`}}",
            "RSYNC_OPTS={{user `provisiondir_rsync_opts`}}",
            "DO_UP={{user `DO_UP`}}",
            "DO_CONTAINER_STRIP={{user `DO_CONTAINER_STRIP`}}"
        ],
        "script": "{{user `docker_folder`}}/provision.sh"
    }],
    "post-processors": [{
        "type": "docker-tag",
        "repository": "{{user `tag`}}"
    }]
}
